<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Getting Started — Web Agent API</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../shared/styles.css">
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--demo-space-10) var(--demo-space-6);
      min-height: 100vh;
    }

    /* Page-specific controls styling */
    .controls {
      margin-top: var(--demo-space-6);
      display: flex;
      gap: var(--demo-space-3);
    }

    .btn {
      flex: 1;
      padding: var(--demo-space-4) var(--demo-space-6);
      border: none;
      border-radius: var(--demo-radius-md);
      font-family: var(--demo-font-sans);
      font-size: var(--demo-text-sm);
      font-weight: var(--demo-weight-semibold);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--demo-space-2);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--demo-accent-primary), var(--demo-accent-secondary));
      color: white;
      box-shadow: var(--demo-shadow-sm);
    }

    .btn-primary:hover:not(:disabled) {
      filter: brightness(1.1);
      transform: translateY(-1px);
      box-shadow: var(--demo-shadow-glow);
    }

    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--demo-bg-surface);
      border: 1px solid var(--demo-border-default);
      color: var(--demo-text-secondary);
    }

    .btn-secondary:hover {
      background: var(--demo-bg-overlay);
      color: var(--demo-text-primary);
    }

    /* Footer */
    .footer {
      margin-top: var(--demo-space-12);
      text-align: center;
      font-size: var(--demo-text-sm);
      color: var(--demo-text-muted);
    }

    .footer a {
      color: var(--demo-text-secondary);
      text-decoration: none;
    }

    .footer a:hover {
      color: var(--demo-accent-primary);
    }
  </style>
</head>
<body class="demo-bg-grid">
  <div class="page-container">
    <header class="demo-header">
      <div class="header-badge">
        <span class="dot"></span>
        <span>Interactive Walkthrough</span>
      </div>
      <h1 class="demo-title demo-text-gradient">Getting Started with the Web Agent API</h1>
      <p class="demo-subtitle">Step through the basics: detect the API, get permission, and make your first AI-powered tool call.</p>
    </header>

    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
    </div>

    <div class="checklist" id="checklist">
      <div class="step waiting" data-step="0">
        <div class="step-icon">1</div>
        <div class="step-content">
          <div class="step-title">Detect Web Agent API</div>
          <div class="step-description">Check if the Web Agent API is available in the page</div>
          <pre class="step-code"><span class="comment">// Check for Web Agent API availability</span>
<span class="keyword">if</span> (window.<span class="property">ai</span> && window.<span class="property">agent</span>) {
  console.<span class="method">log</span>(<span class="string">'Web Agent API is ready!'</span>);
}</pre>
        </div>
      </div>

      <div class="step waiting" data-step="1">
        <div class="step-icon">2</div>
        <div class="step-content">
          <div class="step-title">Request Permission</div>
          <div class="step-description">Ask the user for permission to use AI and tools</div>
          <pre class="step-code"><span class="keyword">const</span> result = <span class="keyword">await</span> window.<span class="property">agent</span>.<span class="method">requestPermissions</span>({
  <span class="property">scopes</span>: [
    <span class="string">'model:prompt'</span>,
    <span class="string">'model:tools'</span>,
    <span class="string">'mcp:tools.list'</span>,
    <span class="string">'mcp:tools.call'</span>
  ],
  <span class="property">reason</span>: <span class="string">'Getting Started demo'</span>
});

<span class="keyword">if</span> (result.<span class="property">granted</span>) {
  console.<span class="method">log</span>(<span class="string">'Permission granted!'</span>);
}</pre>
        </div>
      </div>

      <div class="step waiting" data-step="2">
        <div class="step-icon">3</div>
        <div class="step-content">
          <div class="step-title">Check Available Tools</div>
          <div class="step-description">List MCP tools from connected servers</div>
          <pre class="step-code"><span class="keyword">const</span> tools = <span class="keyword">await</span> window.<span class="property">agent</span>.<span class="property">tools</span>.<span class="method">list</span>();

console.<span class="method">log</span>(<span class="string">`Found ${</span>tools.<span class="property">length</span><span class="string">} tools:`</span>);
tools.<span class="method">forEach</span>(t => console.<span class="method">log</span>(<span class="string">`  • ${</span>t.<span class="property">name</span><span class="string">}`</span>));</pre>
        </div>
      </div>

      <div class="step waiting" data-step="3">
        <div class="step-icon">4</div>
        <div class="step-content">
          <div class="step-title">Ask "What time is it?"</div>
          <div class="step-description">Run an AI agent that can use tools to answer</div>
          <pre class="step-code"><span class="keyword">for await</span> (<span class="keyword">const</span> event <span class="keyword">of</span> window.<span class="property">agent</span>.<span class="method">run</span>({
  <span class="property">task</span>: <span class="string">'What is the current time?'</span>,
  <span class="property">maxToolCalls</span>: <span class="number">3</span>
})) {
  <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="string">'tool_call'</span>) {
    console.<span class="method">log</span>(<span class="string">'Using tool:'</span>, event.<span class="property">tool</span>);
  }
  <span class="keyword">if</span> (event.<span class="property">type</span> === <span class="string">'final'</span>) {
    console.<span class="method">log</span>(<span class="string">'Response:'</span>, event.<span class="property">output</span>);
  }
}</pre>
        </div>
      </div>

      <div class="step waiting" data-step="4">
        <div class="step-icon">5</div>
        <div class="step-content">
          <div class="step-title">Display Response</div>
          <div class="step-description">Show the AI's response</div>
          <pre class="step-code"><span class="comment">// The agent's final response from the previous step</span>
console.<span class="method">log</span>(response);</pre>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-secondary" id="reset-btn" style="display: none;">
        ↺ Start Over
      </button>
      <button class="btn btn-primary" id="next-btn">
        Run Step 1 →
      </button>
    </div>

    <footer class="footer">
      <a href="../../">← Back to Demos</a>
    </footer>
  </div>

  <script>
    const steps = [
      {
        title: 'Detect Web Agent API',
        run: async () => {
          await delay(500);
          if (!window.ai || !window.agent) {
            throw new Error('Web Agent API not detected.\n\nMake sure:\n• A Web Agent API implementation is installed\n• This page is allowed access');
          }
          return '✓ window.ai\n✓ window.agent';
        }
      },
      {
        title: 'Request Permission',
        run: async () => {
          const result = await window.agent.requestPermissions({
            scopes: ['model:prompt', 'model:tools', 'mcp:tools.list', 'mcp:tools.call'],
            reason: 'Getting Started demo - to show how the Web Agent API works'
          });
          
          if (!result.granted) {
            throw new Error('Permission denied by user');
          }
          return '✓ Permission granted';
        }
      },
      {
        title: 'Check Available Tools',
        run: async () => {
          const tools = await window.agent.tools.list();
          
          if (!tools || tools.length === 0) {
            throw new Error('No MCP tools available.\n\nStart an MCP server first.');
          }
          
          const toolNames = tools.map(t => t.name).slice(0, 8);
          let output = `Found ${tools.length} tool${tools.length === 1 ? '' : 's'}:\n`;
          output += toolNames.map(n => `  • ${n}`).join('\n');
          if (tools.length > 8) {
            output += `\n  ... and ${tools.length - 8} more`;
          }
          
          return output;
        }
      },
      {
        title: 'Ask "What time is it?"',
        run: async () => {
          // Store the response for the next step
          window._webAgentDemoResponse = '';
          window._webAgentDemoToolCalls = [];
          window._webAgentDemoThinking = [];
          let tokenText = '';
          
          // Use the agent API to run with tools (matches displayed code)
          for await (const event of window.agent.run({
            task: 'What is the current time?',
            maxToolCalls: 3
          })) {
            // Log all events for debugging
            console.log('[Demo] Agent event:', event.type, event);
            
            // Capture thinking events for display
            if (event.type === 'thinking') {
              window._webAgentDemoThinking.push(event.content);
            }
            
            // These match what's shown in the UI
            if (event.type === 'tool_call') {
              console.log('Using tool:', event.tool);
              window._webAgentDemoToolCalls.push(event.tool);
            }
            if (event.type === 'final') {
              console.log('Response:', event.output);
              window._webAgentDemoResponse = event.output || tokenText;
            }
            
            // Additional handling for demo functionality
            if (event.type === 'token' && event.token) {
              tokenText += event.token;
            }
            if (event.type === 'error') {
              throw new Error(event.error?.message || 'Agent error');
            }
          }
          
          // Fallback to token text if no final output
          if (!window._webAgentDemoResponse && tokenText) {
            window._webAgentDemoResponse = tokenText;
          }
          
          let output = '✓ Request sent to AI agent\n';
          
          // Show thinking/debug info
          if (window._webAgentDemoThinking.length > 0) {
            output += `\n[Debug]:\n`;
            output += window._webAgentDemoThinking.map(t => `  ${t}`).join('\n');
            output += '\n';
          }
          
          if (window._webAgentDemoToolCalls.length > 0) {
            output += `\nTools used:\n`;
            output += window._webAgentDemoToolCalls.map(t => `  • ${t}`).join('\n');
          } else {
            output += '\n(No tools were used)';
          }
          return output;
        }
      },
      {
        title: 'Display Response',
        run: async () => {
          await delay(300);
          if (!window._webAgentDemoResponse) {
            // Provide more context about what happened
            const toolsUsed = window._webAgentDemoToolCalls?.length || 0;
            throw new Error(`No response received from the AI.\n\nTools used: ${toolsUsed}\n\nCheck the browser console for details.`);
          }
          return window._webAgentDemoResponse;
        }
      }
    ];

    let currentStep = -1;
    const totalSteps = steps.length;

    const nextBtn = document.getElementById('next-btn');
    const resetBtn = document.getElementById('reset-btn');
    const progressFill = document.getElementById('progress-fill');
    const checklist = document.getElementById('checklist');

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function updateProgress() {
      const percent = ((currentStep + 1) / totalSteps) * 100;
      progressFill.style.width = `${percent}%`;
    }

    function getStepElement(index) {
      return checklist.querySelector(`[data-step="${index}"]`);
    }

    function setStepState(index, state, output = null) {
      const el = getStepElement(index);
      el.className = `step ${state}`;
      
      const icon = el.querySelector('.step-icon');
      if (state === 'completed') {
        icon.textContent = '✓';
      } else if (state === 'error') {
        icon.textContent = '✗';
      } else if (state === 'active') {
        icon.innerHTML = '<div class="spinner"></div>';
      } else {
        icon.textContent = index + 1;
      }

      // Remove existing output
      const existingOutput = el.querySelector('.step-output');
      const existingLabel = el.querySelector('.output-label');
      if (existingOutput) existingOutput.remove();
      if (existingLabel) existingLabel.remove();

      // Add new output if provided
      if (output) {
        const labelEl = document.createElement('div');
        labelEl.className = 'output-label';
        labelEl.textContent = state === 'error' ? '✗ Error' : '→ Output';
        
        const outputEl = document.createElement('div');
        outputEl.className = `step-output ${state === 'error' ? 'error' : 'success'}`;
        outputEl.textContent = output;
        
        el.querySelector('.step-content').appendChild(labelEl);
        el.querySelector('.step-content').appendChild(outputEl);
      }
    }

    async function runStep(index) {
      const step = steps[index];
      setStepState(index, 'active');
      
      try {
        const result = await step.run();
        setStepState(index, 'completed', result);
        return true;
      } catch (err) {
        setStepState(index, 'error', err.message);
        return false;
      }
    }

    async function next() {
      if (currentStep >= totalSteps - 1) {
        return;
      }

      currentStep++;
      updateProgress();

      nextBtn.disabled = true;
      nextBtn.innerHTML = '<div class="spinner"></div> Running...';

      const success = await runStep(currentStep);

      if (success && currentStep < totalSteps - 1) {
        nextBtn.disabled = false;
        nextBtn.textContent = `Run Step ${currentStep + 2} →`;
      } else if (success && currentStep === totalSteps - 1) {
        nextBtn.disabled = true;
        nextBtn.textContent = 'Complete! ✓';
        nextBtn.style.background = 'var(--demo-success)';
        resetBtn.style.display = 'block';
      } else {
        // Error occurred
        nextBtn.disabled = false;
        nextBtn.textContent = 'Retry →';
        currentStep--; // Allow retry
        resetBtn.style.display = 'block';
      }
    }

    function reset() {
      currentStep = -1;
      updateProgress();
      
      // Reset all steps
      for (let i = 0; i < totalSteps; i++) {
        const el = getStepElement(i);
        el.className = 'step waiting';
        el.querySelector('.step-icon').textContent = i + 1;
        const output = el.querySelector('.step-output');
        const label = el.querySelector('.output-label');
        if (output) output.remove();
        if (label) label.remove();
      }

      nextBtn.disabled = false;
      nextBtn.textContent = 'Run Step 1 →';
      nextBtn.style.background = '';
      resetBtn.style.display = 'none';
    }

    nextBtn.addEventListener('click', next);
    resetBtn.addEventListener('click', reset);
  </script>
</body>
</html>
