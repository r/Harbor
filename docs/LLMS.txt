# Harbor Web Agents API - Reference for AI Coding Assistants

> **WHAT THIS IS**: A compact, token-efficient reference for Claude, Cursor, Copilot, or any AI assistant building web apps with the Web Agents API. This document is designed to give you everything you need to write working code quickly.
>
> **HUMAN DOCS**: For detailed explanations and examples, see WEB_AGENTS_API.md, JS_AI_PROVIDER_API.md, and DEVELOPER_GUIDE.md.

---

## TL;DR - Copy This to Start

```javascript
// 1. Check availability
if (!window.agent) throw new Error('Web Agents API not available');

// 2. Request permissions (REQUIRED before any API use)
const { granted } = await window.agent.requestPermissions({
  scopes: ['model:prompt', 'model:tools', 'mcp:tools.list', 'mcp:tools.call'],
  reason: 'Enable AI features'
});
if (!granted) throw new Error('Permissions denied');

// 3. Use text generation
const session = await window.ai.createTextSession({ systemPrompt: 'Be helpful.' });
const response = await session.prompt('Hello!');
session.destroy();

// 4. Or run an autonomous agent
for await (const event of window.agent.run({ task: 'Search for AI news' })) {
  if (event.type === 'final') console.log(event.output);
}
```

---

## Global Objects

The API exposes two globals to every web page:

| Object | Purpose |
|--------|---------|
| `window.ai` | Text generation (Chrome Prompt API compatible) |
| `window.agent` | Tools, browser control, sessions, multi-agent |

Harbor also exposes `window.harbor.ai` and `window.harbor.agent` which are always available regardless of Chrome AI presence.

---

## Detection

```javascript
// Basic check
if (window.agent && window.ai) { /* ready */ }

// Wait for ready event (recommended)
window.addEventListener('agent-ready', (e) => {
  console.log('Version:', e.detail.version);
  console.log('Features:', e.detail.features);
});
```

---

## Permissions (MUST REQUEST FIRST)

All APIs require permission. Request once per origin.

### Request Permissions

```javascript
const result = await window.agent.requestPermissions({
  scopes: ['model:prompt', 'mcp:tools.call'],  // Required scopes
  reason: 'To help with your task',             // Shown to user
  tools: ['time-wasm/time.now']                 // Optional: allowlist specific tools
});

if (result.granted) {
  // All scopes granted
} else {
  // Check individual: result.scopes['model:prompt'] === 'granted-always'
}
```

### Permission Scopes

| Scope | Risk | What It Enables |
|-------|------|-----------------|
| `model:prompt` | Low | `ai.createTextSession()`, `session.prompt()` |
| `model:tools` | Medium | `agent.run()` autonomous agent |
| `model:list` | Low | `ai.providers.list()` |
| `mcp:tools.list` | Low | `agent.tools.list()` |
| `mcp:tools.call` | Medium | `agent.tools.call()` |
| `mcp:servers.register` | Medium | `agent.mcp.register()` BYOC |
| `browser:activeTab.read` | Medium | `agent.browser.activeTab.readability()` |
| `browser:activeTab.interact` | High | Click, fill, scroll on active tab |
| `browser:activeTab.screenshot` | Medium | Screenshots |
| `browser:tabs.read` | Medium | `agent.browser.tabs.list()` |
| `browser:tabs.create` | High | Create/control new tabs |
| `web:fetch` | High | CORS-bypassing fetch |
| `chat:open` | Low | Open browser chat UI |
| `agents:register` | Medium | Multi-agent registration |
| `agents:invoke` | Medium | Call other agents |

### Grant Types

| Grant | Meaning |
|-------|---------|
| `granted-always` | Persistent |
| `granted-once` | 10 min or until tab closes |
| `denied` | User said no |
| `not-granted` | Never requested |

### Check Current Permissions

```javascript
const { scopes, allowedTools } = await window.agent.permissions.list();
```

---

## window.ai - Text Generation

### Create Session & Prompt

```javascript
const session = await window.ai.createTextSession({
  systemPrompt: 'You are helpful.',  // Optional
  temperature: 0.7,                   // Optional: 0.0-2.0
  provider: 'ollama',                 // Optional: specific provider
  model: 'llama3.2'                   // Optional: specific model
});

// Simple prompt
const response = await session.prompt('What is 2+2?');

// Streaming
for await (const event of session.promptStreaming('Tell me a story')) {
  if (event.type === 'token') process.stdout.write(event.token);
  if (event.type === 'done') break;
  if (event.type === 'error') throw new Error(event.error.message);
}

// Cleanup (important!)
session.destroy();
```

### List Providers

```javascript
const providers = await window.ai.providers.list();
// Returns: [{ id, type, name, available, isDefault, supportsTools, ... }]

const { provider, model } = await window.ai.providers.getActive();
```

### Native Browser AI (Firefox 142+, Chrome 131+)

```javascript
const best = await window.ai.runtime.getBest();  // 'firefox' | 'chrome' | 'harbor' | null
const caps = await window.ai.runtime.getCapabilities();

// Use Firefox native AI
const session = await window.ai.createTextSession({ provider: 'firefox-wllama' });
```

---

## window.agent - Tools & Agent

### List Tools

```javascript
const tools = await window.agent.tools.list();
// Returns: [{ name: 'serverId/toolName', description, inputSchema, serverId }]
```

### Call Tool Directly

```javascript
const result = await window.agent.tools.call({
  tool: 'time-wasm/time.now',
  args: { timezone: 'America/New_York' }
});
```

### Run Autonomous Agent

The most powerful API. Runs an agentic loop that can call tools.

```javascript
for await (const event of window.agent.run({
  task: 'What time is it in Tokyo?',
  maxToolCalls: 5,        // Default: 5
  tools: ['time-wasm/*'], // Optional: filter tools
  useAllTools: false,     // Set true to disable smart routing
  provider: 'openai'      // Optional: specific LLM
})) {
  switch (event.type) {
    case 'status':      console.log('Status:', event.message); break;
    case 'tool_call':   console.log('Calling:', event.tool, event.args); break;
    case 'tool_result': console.log('Result:', event.result); break;
    case 'token':       process.stdout.write(event.token); break;
    case 'final':       console.log('Answer:', event.output); break;
    case 'error':       throw new Error(event.error.message);
  }
}
```

---

## Browser APIs

### Read Active Tab (browserInteraction flag)

```javascript
const { url, title, text } = await window.agent.browser.activeTab.readability();
```

### Interact with Active Tab

```javascript
await window.agent.browser.activeTab.click('ref-123');
await window.agent.browser.activeTab.fill('ref-456', 'Hello');
await window.agent.browser.activeTab.select('ref-789', 'option-value');
await window.agent.browser.activeTab.scroll('down', 500);
const { dataUrl } = await window.agent.browser.activeTab.screenshot();
```

### Navigate & Tabs (browserControl flag)

```javascript
await window.agent.browser.navigate('https://example.com');
const tabs = await window.agent.browser.tabs.list();
const newTab = await window.agent.browser.tabs.create({ url: '...', active: false });
await window.agent.browser.tab.waitForLoad(newTab.id);
const { html } = await window.agent.browser.tab.getHtml(newTab.id, 'main');
await window.agent.browser.tabs.close(newTab.id);

// CORS-bypassing fetch
const response = await window.agent.fetch('https://api.example.com/data');
```

---

## Sessions API

Create sessions with specific capabilities and limits.

```javascript
const session = await window.agent.sessions.create({
  name: 'Research Assistant',
  capabilities: {
    llm: { provider: 'ollama', model: 'llama3.2' },
    tools: ['web-search/search', 'memory/save'],
    browser: ['read', 'screenshot']
  },
  limits: { maxToolCalls: 20, ttlMinutes: 30 }
});

const response = await session.prompt('Find AI news');
const result = await session.callTool('web-search/search', { query: 'AI' });
await session.terminate();
```

---

## Multi-Agent API

### Register as Agent

```javascript
const agent = await window.agent.agents.register({
  name: 'Research Agent',
  capabilities: ['search', 'summarize'],
  acceptsInvocations: true,
  acceptsMessages: true
});

// Handle invocations from other agents
window.agent.agents.onInvoke(async (req) => {
  if (req.task === 'search') return { results: [...] };
  throw new Error('Unknown task');
});
```

### Discover & Invoke Agents

```javascript
const { agents } = await window.agent.agents.discover({ capabilities: ['analyze'] });
const response = await window.agent.agents.invoke(agentId, {
  task: 'analyze',
  input: data,
  timeout: 30000
});
```

### Orchestration Patterns

```javascript
// Pipeline: sequential
await window.agent.agents.orchestrate.pipeline({
  steps: [
    { agentId: 'researcher', task: 'research' },
    { agentId: 'writer', task: 'write' }
  ]
}, initialInput);

// Parallel: concurrent
await window.agent.agents.orchestrate.parallel({
  tasks: [{ agentId: 'a1', task: 'analyze', input: data }, ...],
  combineStrategy: 'merge'  // 'array' | 'merge' | 'first'
});

// Route: conditional
await window.agent.agents.orchestrate.route({
  routes: [{ condition: 'type:technical', agentId: 'tech-agent' }],
  defaultAgentId: 'general-agent'
}, input, task);
```

---

## BYOC (Bring Your Own Chatbot)

Let websites use the user's AI while providing site-specific tools.

### HTML Declaration

```html
<link rel="mcp-server" href="https://shop.example/mcp" 
      title="Shop" data-tools="search,add_to_cart">
```

### API

```javascript
// Discover link-declared servers
const servers = await window.agent.mcp.discover();

// Register website's MCP server
const reg = await window.agent.mcp.register({
  url: 'https://shop.example/mcp',
  name: 'Shop Assistant',
  tools: ['search', 'add_to_cart']
});

// Open browser chat
const chat = await window.agent.chat.open({
  systemPrompt: 'Shopping assistant',
  tools: ['search', 'add_to_cart'],
  style: { theme: 'light', accentColor: '#ff9900' }
});

await window.agent.chat.close(chat.chatId);
await window.agent.mcp.unregister(reg.serverId);
```

---

## Error Codes

| Code | Meaning |
|------|---------|
| `ERR_FEATURE_DISABLED` | Feature flag is off |
| `ERR_NOT_INSTALLED` | Extension not installed |
| `ERR_PERMISSION_DENIED` | User denied |
| `ERR_SCOPE_REQUIRED` | Missing permission scope |
| `ERR_TOOL_NOT_ALLOWED` | Tool not in allowlist |
| `ERR_TOOL_NOT_FOUND` | Tool doesn't exist |
| `ERR_TOOL_FAILED` | Tool execution failed |
| `ERR_TOOL_TIMEOUT` | Tool call timed out |
| `ERR_MODEL_FAILED` | LLM error |
| `ERR_SESSION_NOT_FOUND` | Session destroyed |
| `ERR_TIMEOUT` | Request timed out |
| `ERR_AGENT_NOT_FOUND` | Agent not registered |
| `ERR_INTERNAL` | Internal error |

### Error Handling Pattern

```javascript
try {
  await window.agent.tools.list();
} catch (err) {
  if (err.code === 'ERR_SCOPE_REQUIRED') {
    await window.agent.requestPermissions({ scopes: ['mcp:tools.list'] });
  } else if (err.code === 'ERR_PERMISSION_DENIED') {
    // User denied, show fallback UI
  }
}
```

---

## Feature Flags

APIs are gated by feature flags. Users toggle these in the extension sidebar.

| Flag | Default | APIs |
|------|---------|------|
| `textGeneration` | ON | `window.ai.*` |
| `toolAccess` | ON | `agent.tools.list/call` |
| `toolCalling` | OFF | `agent.run()` |
| `browserInteraction` | OFF | `agent.browser.activeTab.click/fill/scroll` |
| `browserControl` | OFF | `agent.browser.navigate/tabs/fetch` |
| `multiAgent` | OFF | `agent.agents.*` |

Check features at runtime:

```javascript
window.addEventListener('agent-ready', (e) => {
  const { features } = e.detail;
  if (!features.toolCalling) {
    // agent.run() won't work, use tools.call() instead
  }
});
```

---

## TypeScript Types (Quick Reference)

```typescript
// Permissions
type PermissionScope = 'model:prompt' | 'model:tools' | 'model:list' |
  'mcp:tools.list' | 'mcp:tools.call' | 'mcp:servers.register' |
  'browser:activeTab.read' | 'browser:activeTab.interact' | 'browser:activeTab.screenshot' |
  'browser:tabs.read' | 'browser:tabs.create' | 'web:fetch' | 'chat:open' |
  'agents:register' | 'agents:discover' | 'agents:invoke' | 'agents:message';
type PermissionGrant = 'granted-once' | 'granted-always' | 'denied' | 'not-granted';

// Tools
interface ToolDescriptor { name: string; description?: string; inputSchema?: object; serverId?: string; }

// Agent run events
type RunEvent =
  | { type: 'status'; message: string }
  | { type: 'tool_call'; tool: string; args: unknown }
  | { type: 'tool_result'; tool: string; result?: unknown; error?: ApiError }
  | { type: 'token'; token: string }
  | { type: 'final'; output: string; citations?: Citation[] }
  | { type: 'error'; error: ApiError };

// Session
interface TextSession {
  sessionId: string;
  prompt(input: string): Promise<string>;
  promptStreaming(input: string): AsyncIterable<StreamToken>;
  destroy(): void;
}

interface StreamToken {
  type: 'token' | 'done' | 'error';
  token?: string;
  error?: { code: string; message: string };
}

// Browser
interface ActiveTabReadability { url: string; title: string; text: string; }
interface TabInfo { id: number; url: string; title: string; active: boolean; canControl: boolean; }

// Multi-agent
interface AgentInvocationResponse {
  success: boolean;
  result?: unknown;
  error?: { code: string; message: string };
  executionTime?: number;
}
```

---

## Common Patterns

### Initialize App with Permissions

```javascript
async function init() {
  if (!window.agent) {
    showError('Install Harbor extension');
    return false;
  }
  
  const { granted } = await window.agent.requestPermissions({
    scopes: ['model:prompt', 'mcp:tools.list', 'mcp:tools.call'],
    reason: 'Enable AI features'
  });
  
  return granted;
}
```

### Chat Interface

```javascript
let session;

async function sendMessage(text) {
  if (!session) {
    session = await window.ai.createTextSession({
      systemPrompt: 'You are a helpful assistant.'
    });
  }
  return await session.prompt(text);
}

// Streaming version
async function sendMessageStreaming(text, onToken) {
  if (!session) {
    session = await window.ai.createTextSession();
  }
  
  for await (const e of session.promptStreaming(text)) {
    if (e.type === 'token') onToken(e.token);
  }
}
```

### Page Summarizer

```javascript
async function summarizePage() {
  const { text, title } = await window.agent.browser.activeTab.readability();
  const session = await window.ai.createTextSession({
    systemPrompt: 'Summarize in 2-3 sentences.'
  });
  const summary = await session.prompt(text.slice(0, 10000));
  session.destroy();
  return { title, summary };
}
```

### Tool-Calling Agent

```javascript
async function runAgent(task) {
  const events = [];
  
  for await (const event of window.agent.run({ task, maxToolCalls: 5 })) {
    events.push(event);
    
    if (event.type === 'final') {
      return { output: event.output, events };
    }
    if (event.type === 'error') {
      throw new Error(event.error.message);
    }
  }
}
```

### Graceful Degradation

```javascript
async function getAIResponse(prompt) {
  // Try Web Agents API first
  if (window.agent) {
    try {
      const { granted } = await window.agent.requestPermissions({
        scopes: ['model:prompt']
      });
      if (granted) {
        const session = await window.ai.createTextSession();
        const response = await session.prompt(prompt);
        session.destroy();
        return response;
      }
    } catch (e) {
      console.warn('Web Agents API failed:', e);
    }
  }
  
  // Fallback to your own API
  return await fetch('/api/ai', {
    method: 'POST',
    body: JSON.stringify({ prompt })
  }).then(r => r.json());
}
```

---

## Tool Router Keywords

`agent.run()` automatically selects relevant tools based on keywords:

| Keywords | Servers Selected |
|----------|------------------|
| github, repo, commit, PR, issue | github |
| file, folder, directory, read, write | filesystem |
| remember, memory, recall | memory |
| slack, channel, message | slack |
| database, SQL, query, postgres | database, postgres, mysql |
| web, browser, scrape, url | web, browser |
| search, find, google, brave | search, brave |

Override with `tools: [...]` or disable with `useAllTools: true`.

---

## Key Files (for Harbor development)

```
extension/src/
├── agents/
│   ├── injected.ts         # window.ai/agent injection
│   ├── content-script.ts   # Message relay
│   └── api.ts              # API implementation
├── llm/                    # LLM provider management
├── mcp/                    # MCP client
└── multi-agent/            # Agent orchestration

bridge-rs/src/
├── main.rs                 # Native messaging entry
├── llm/                    # LLM providers (ollama, openai, etc.)
├── rpc/                    # RPC handlers
└── js/                     # QuickJS for JS MCP servers
```

---

## Version

Web Agents API v1.3 / Harbor v1

