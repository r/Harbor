# Web Agent API - AI Agent Reference

> This document is optimized for AI coding assistants. For human-readable documentation, see DEVELOPER_GUIDE.md and JS_AI_PROVIDER_API.md.

The Web Agent API is a proposed specification for AI agent capabilities in web pages. Harbor is an implementation (Firefox extension + Node.js bridge).

## Key Concepts

1. Web Agent API exposes `window.ai` and `window.agent` to web pages
2. All API calls require user permission (per-origin)
3. MCP tools are namespaced as `serverId/toolName`
4. Harbor implements this via extension + native messaging bridge
5. The bridge manages MCP servers, LLM providers, and chat orchestration

## Quick Start

```js
// Check availability
if (window.agent) { /* Web Agent API available */ }

// Request permissions (required before any API use)
await window.agent.requestPermissions({
  scopes: ['model:prompt', 'model:tools', 'mcp:tools.list', 'mcp:tools.call'],
  reason: 'Why your app needs AI'
});
```

## Permissions

SCOPES:
- model:prompt     → Basic text generation
- model:tools      → AI with tool calling
- mcp:tools.list   → List available MCP tools
- mcp:tools.call   → Execute MCP tools
- mcp:servers.register → Register website MCP servers (BYOC)
- browser:activeTab.read → Read active tab content
- chat:open        → Open browser chat UI (BYOC)

GRANTS: granted-always | granted-once | denied | not-granted

## window.ai - Text Generation

```js
// Create session (auto-selects best available provider)
const session = await window.ai.createTextSession({
  systemPrompt: 'You are helpful.',  // optional
  temperature: 0.7,                   // optional, 0.0-2.0
  provider: 'firefox-wllama'          // optional: explicit provider
});

// Simple prompt
const response = await session.prompt('Hello');

// Streaming
for await (const e of session.promptStreaming('Tell me a story')) {
  if (e.type === 'token') console.log(e.token);
  if (e.type === 'done') break;
  if (e.type === 'error') throw e.error;
}

// Cleanup
await session.destroy();
```

## window.agent - Tools & Agent

### List/Call Tools

```js
// List all tools (requires mcp:tools.list)
const tools = await window.agent.tools.list();
// Returns: [{ name: 'serverId/toolName', description, inputSchema }, ...]

// Call a tool (requires mcp:tools.call)
const result = await window.agent.tools.call({
  tool: 'memory-server/save_memory',
  args: { content: 'Remember this' }
});
```

### Read Active Tab

```js
// Requires browser:activeTab.read
const tab = await window.agent.browser.activeTab.readability();
// Returns: { url, title, text }
```

### Agent Run (Autonomous Tasks)

Built-in tool router auto-selects relevant tools based on keywords (e.g., "GitHub" → GitHub tools only).

```js
for await (const event of window.agent.run({
  task: 'Research AI news and summarize',
  tools: ['search/web_search'],  // optional filter (overrides router)
  useAllTools: false,            // true = disable router
  maxToolCalls: 5,               // default: 5
  requireCitations: true         // optional
})) {
  switch (event.type) {
    case 'status':      // { message: string }
    case 'tool_call':   // { tool: string, args: any }
    case 'tool_result': // { tool: string, result: any, error?: ApiError }
    case 'token':       // { token: string }
    case 'final':       // { output: string, citations?: [...] }
    case 'error':       // { error: ApiError }
  }
}
```

## BYOC (Bring Your Own Chatbot)

Websites can integrate with user's AI via MCP servers and browser chat UI.

### Declarative Discovery (HTML)
```html
<link rel="mcp-server" href="https://shop.example/mcp" 
      title="Shop" data-tools="search,add_to_cart">
```

### API Methods
```js
// Discover link-declared servers
const servers = await window.agent.mcp.discover();
// Returns: [{ url, title, description, tools }]

// Register website's MCP server
const reg = await window.agent.mcp.register({
  url: 'https://shop.example/mcp',
  name: 'Shop Assistant',
  tools: ['search', 'add_to_cart']
});
if (reg.success) console.log('Registered:', reg.serverId);

// Check chat availability
const avail = await window.agent.chat.canOpen(); // 'readily' | 'no'

// Open browser chat
const chat = await window.agent.chat.open({
  systemPrompt: 'Shopping assistant',
  tools: ['search', 'add_to_cart'],
  style: { theme: 'light', accentColor: '#ff9900' }
});

// Close chat
await window.agent.chat.close(chat.chatId);

// Unregister server
await window.agent.mcp.unregister(reg.serverId);
```

## Error Codes

ERR_NOT_INSTALLED       → Extension not installed
ERR_PERMISSION_DENIED   → User denied
ERR_SCOPE_REQUIRED      → Missing permission scope
ERR_TOOL_NOT_ALLOWED    → Tool not in allowlist
ERR_TOOL_NOT_FOUND      → Tool doesn't exist
ERR_TOOL_FAILED         → Tool execution failed
ERR_TOOL_TIMEOUT        → Tool call timed out
ERR_MODEL_FAILED        → LLM error
ERR_SESSION_NOT_FOUND   → Session destroyed
ERR_TIMEOUT             → Request timed out
ERR_RATE_LIMITED        → Rate limit exceeded
ERR_SERVER_UNAVAILABLE  → MCP server unavailable
ERR_INTERNAL            → Internal error

## Bridge Message Types (for extension development)

### Server Management
add_server, remove_server, list_servers, connect_server, disconnect_server

### MCP Operations
mcp_connect, mcp_disconnect, mcp_list_connections, mcp_list_tools,
mcp_list_resources, mcp_list_prompts, mcp_call_tool, mcp_read_resource

### Catalog
catalog_get, catalog_refresh, catalog_search

### Installer
check_runtimes, install_server, uninstall_server, list_installed,
start_installed, stop_installed, set_server_secrets, get_server_status

### LLM
llm_detect, llm_list_providers, llm_set_active, llm_list_models, llm_chat

### Chat Orchestration
chat_create_session, chat_send_message, chat_get_session, chat_list_sessions,
chat_delete_session, chat_update_session, chat_clear_messages

## Architecture (Harbor Implementation)

Web Page (window.ai/agent) ←postMessage→ Content Script ←runtime→ Background
    ↓ native messaging (stdio JSON)
Node.js Bridge (bridge-ts/)
    ↓ MCP Protocol
MCP Servers (stdio/HTTP/Docker)

## LLM Providers

### Native Browser Providers (no bridge required)
- firefox-wllama: Firefox 142+ local LLM (wllama/llama.cpp)
- firefox-transformers: Firefox 134+ embeddings (Transformers.js)
- chrome: Chrome 131+ built-in AI

### Bridge Providers
- llamafile: localhost:8080
- ollama: localhost:11434 (requires 0.3.0+ for tools)
- openai: OpenAI API (requires API key)
- anthropic: Anthropic Claude API (requires API key)

### Provider Selection
```js
// Use specific provider
const session = await window.ai.createTextSession({
  provider: 'firefox-wllama',  // or 'ollama', 'openai', etc.
  model: 'llama-3.2-1b'
});

// Check available providers
const providers = await window.ai.providers.list();
// Returns: [{ id, type, name, available, isNative, supportsTools, ... }]

// Get best runtime
const best = await window.ai.runtime.getBest();  // 'firefox' | 'chrome' | 'harbor' | null
```

### Split Routing
Use native browser AI for chat, bridge for tools:
```js
// Chat with Firefox local AI
const session = await window.ai.createTextSession({ provider: 'firefox-wllama' });
await session.prompt('Hello');

// Agent with bridge provider (full tool support)
for await (const e of window.agent.run({
  task: 'Search and summarize',
  provider: 'openai'  // Use bridge provider for tools
})) { ... }
```

## Tool Router Keywords

| Keywords | Servers Selected |
|----------|------------------|
| github, repo, commit, PR, issue | github |
| file, folder, directory, read, write | filesystem |
| remember, memory, recall, knowledge | memory |
| slack, channel, message | slack |
| database, SQL, query, postgres | database, postgres, mysql |
| web, browser, scrape, url | web, browser |
| search, find, google, brave | search, brave |

## Data Storage (~/.harbor/)

harbor.db              → Server configs (SQLite)
catalog.db             → Catalog cache (SQLite)
installed_servers.json → Installed servers
secrets/credentials.json → API keys
sessions/*.json        → Chat history

## Types Reference

```ts
type PermissionScope = 'model:prompt' | 'model:tools' | 'mcp:tools.list' | 'mcp:tools.call' 
  | 'mcp:servers.register' | 'browser:activeTab.read' | 'chat:open';
type PermissionGrant = 'granted-once' | 'granted-always' | 'denied' | 'not-granted';

interface ToolDescriptor { name: string; description?: string; inputSchema?: object; serverId?: string; }
interface ActiveTabReadability { url: string; title: string; text: string; }
interface StreamToken { type: 'token' | 'done' | 'error'; token?: string; error?: ApiError; }
interface ApiError { code: string; message: string; details?: unknown; }

type RunEvent =
  | { type: 'status'; message: string }
  | { type: 'tool_call'; tool: string; args: unknown }
  | { type: 'tool_result'; tool: string; result: unknown; error?: ApiError }
  | { type: 'token'; token: string }
  | { type: 'final'; output: string; citations?: Citation[] }
  | { type: 'error'; error: ApiError };

interface Citation { source: 'tab' | 'tool'; ref: string; excerpt: string; }

// BYOC Types
interface MCPServerRegistration { url: string; name: string; description?: string; tools?: string[]; }
interface MCPRegistrationResult { success: boolean; serverId?: string; error?: { code: string; message: string; }; }
type ChatAvailability = 'readily' | 'no';
interface ChatOpenOptions { systemPrompt?: string; tools?: string[]; style?: { theme?: string; accentColor?: string; }; }
interface ChatOpenResult { success: boolean; chatId?: string; error?: { code: string; message: string; }; }

// Provider Types
interface LLMProviderInfo {
  id: string; type: string; name: string; available: boolean;
  isDefault: boolean; isTypeDefault: boolean; supportsTools?: boolean;
  isNative?: boolean;  // true for browser-native (firefox, chrome)
  runtime?: 'firefox' | 'chrome' | 'bridge';
  downloadRequired?: boolean; downloadProgress?: number;
}

// Runtime Types
interface RuntimeCapabilities {
  firefox: { available: boolean; hasWllama: boolean; hasTransformers: boolean; supportsTools: boolean; } | null;
  chrome: { available: boolean; supportsTools: boolean; } | null;
  harbor: { available: boolean; bridgeConnected: boolean; providers: string[]; };
}
```

## Complete Example

```js
async function main() {
  // 1. Check availability
  if (!window.agent) throw new Error('Web Agent API not available');

  // 2. Request permissions
  const perm = await window.agent.requestPermissions({
    scopes: ['model:prompt', 'model:tools', 'mcp:tools.list', 'mcp:tools.call'],
    reason: 'AI assistant features'
  });
  if (!perm.granted) throw new Error('Permissions denied');

  // 3. List available tools
  const tools = await window.agent.tools.list();
  console.log('Tools:', tools.map(t => t.name));

  // 4. Run agent task
  let output = '';
  for await (const e of window.agent.run({ task: 'What tools are available?' })) {
    if (e.type === 'token') output += e.token;
    if (e.type === 'final') output = e.output;
    if (e.type === 'error') throw new Error(e.error.message);
  }
  console.log('Result:', output);

  // 5. Direct tool call
  await window.agent.tools.call({
    tool: 'memory-server/save_memory',
    args: { content: output }
  });
}
```

## Project File Reference

Key source files for understanding Harbor:

```
extension/src/
├── background.ts        # Native messaging, permission handling
├── sidebar.ts           # UI for server management
├── provider/
│   ├── types.ts         # API type definitions
│   ├── provider-bridge.ts # Message routing to extension
│   └── provider-injected.ts # window.ai/agent injection

bridge-ts/src/
├── main.ts              # Bridge entry point
├── handlers.ts          # All message handlers
├── host/
│   ├── permissions.ts   # Permission system
│   ├── tool-registry.ts # Tool namespacing
│   └── rate-limiter.ts  # Rate limiting
├── chat/
│   ├── orchestrator.ts  # Agent loop
│   └── tool-router.ts   # Intelligent tool selection
├── llm/
│   ├── manager.ts       # LLM provider abstraction
│   ├── ollama.ts        # Ollama provider
│   └── llamafile.ts     # llamafile provider
├── mcp/
│   ├── manager.ts       # MCP connection management
│   └── stdio-client.ts  # stdio transport
└── installer/
    ├── manager.ts       # Server installation
    └── secrets.ts       # Credential storage
```

## Common Patterns

```js
// Check if Web Agent API is available
if (typeof window.agent === 'undefined') {
  // Web Agent API not available
}

// Handle permission denial
try {
  await window.agent.tools.list();
} catch (e) {
  if (e.code === 'ERR_SCOPE_REQUIRED') {
    await window.agent.requestPermissions({ scopes: ['mcp:tools.list'] });
  }
}

// Streaming with abort
const controller = new AbortController();
for await (const e of window.agent.run({ task: '...', signal: controller.signal })) {
  // controller.abort() to cancel
}

// Read page content
const { url, title, text } = await window.agent.browser.activeTab.readability();
```

